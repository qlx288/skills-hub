---
name: save-itinerary
description: 保存旅行计划到本地文件。当用户要求保存行程、导出行程、生成行程文件时使用。
---

# 行程保存指南

## 功能说明

将生成的旅行计划保存为 Markdown 文件到本地，方便用户查看、打印或分享。

## ⚠️ 重要：长行程保存策略

**长行程（超过7天或内容很多）容易保存失败！必须采用以下策略：**

### 1. 分段写入法

对于长行程，不要一次性写入全部内容，而是分段追加：

```bash
# 第一步：创建文件并写入头部信息
write 文件路径 <<< "# 行程标题\n\n## 行程概览\n..."

# 第二步：追加 Day 1-3
write --append 文件路径 <<< "## Day 1\n..."

# 第三步：追加 Day 4-7
write --append 文件路径 <<< "## Day 4\n..."

# 继续追加...直到完成
```

### 2. 分文件法（推荐超长行程）

对于超过14天的行程，建议分成多个文件：

```
旅行计划/
├── 2024-02-17_北欧蜜月_总览.md      # 概览、预算、打包清单
├── 2024-02-17_北欧蜜月_Day01-07.md  # 第1-7天详细行程
├── 2024-02-17_北欧蜜月_Day08-14.md  # 第8-14天详细行程
├── 2024-02-17_北欧蜜月_Day15-22.md  # 第15-22天详细行程
└── 2024-02-17_北欧蜜月_实用信息.md  # 签证、交通、注意事项
```

### 3. 必须验证保存结果！

**每次保存后必须验证文件是否完整：**

```bash
# 保存后立即验证
1. 检查文件是否存在
   ls -la "旅行计划/xxx.md"

2. 检查文件大小（确保不是空文件或被截断）
   wc -l "旅行计划/xxx.md"    # 查看行数
   wc -c "旅行计划/xxx.md"    # 查看字节数

3. 查看文件末尾（确认写入完整）
   tail -20 "旅行计划/xxx.md"  # 查看最后20行

4. 如果是分段写入，检查关键标记是否存在
   grep "Day 22" "旅行计划/xxx.md"  # 确认最后一天存在
   grep "费用总结" "旅行计划/xxx.md" # 确认结尾部分存在
```

## 完整保存流程

### 短行程（≤7天）：直接保存

```
1. 创建文件夹：mkdir -p "旅行计划"
2. 一次性写入：write 完整内容到文件
3. 验证：检查文件存在且内容完整
4. 确认：告知用户保存成功
```

### 中等行程（8-14天）：分两次写入

```
1. 创建文件夹
2. 写入第一部分：概览 + Day 1-7
3. 追加第二部分：Day 8-14 + 费用总结 + 打包清单
4. 验证：检查最后一天和结尾是否存在
5. 确认
```

### 长行程（≥15天）：分文件保存

```
1. 创建文件夹
2. 写入总览文件：概览、预算、打包清单
3. 写入详细行程文件1：Day 1-7
4. 写入详细行程文件2：Day 8-14
5. 写入详细行程文件3：Day 15-...
6. 写入实用信息文件：签证、交通、注意事项
7. 验证每个文件
8. 确认：列出所有保存的文件
```

## 保存规则

### 文件夹
- 默认路径：当前工作目录下的 `旅行计划/` 文件夹
- 如果用户指定了路径，使用用户指定的路径
- 如果文件夹不存在，自动创建

### 文件命名
- 单文件：`[起始日期]-[结束日期]_[目的地].md`
- 多文件：`[起始日期]_[目的地]_[部分].md`

示例：
- `2024-05-01-05-03_杭州.md`
- `2024-02-17_北欧蜜月_总览.md`
- `2024-02-17_北欧蜜月_Day01-07.md`

## 验证失败的处理

如果验证发现文件不完整：

1. **告知用户**：文件可能不完整
2. **重新保存**：尝试分段重新写入
3. **提供备选**：
   - 分成更小的文件
   - 直接在对话中输出内容让用户复制

## 输出确认模板

### 单文件保存成功
```
✅ 行程已保存！

📁 文件位置：旅行计划/2024-05-01-05-03_杭州.md
📄 文件大小：约 XX KB
📝 内容行数：XXX 行

✔️ 验证结果：文件完整，包含全部 X 天行程

💡 打开方式：
- 双击文件用记事本/VS Code 打开
- 或用 Typora 等 Markdown 编辑器查看更美观
```

### 多文件保存成功
```
✅ 行程已保存！共 X 个文件

📁 文件位置：旅行计划/

📄 文件列表：
1. 2024-02-17_北欧蜜月_总览.md (XX KB) ✅
2. 2024-02-17_北欧蜜月_Day01-07.md (XX KB) ✅
3. 2024-02-17_北欧蜜月_Day08-14.md (XX KB) ✅
4. 2024-02-17_北欧蜜月_Day15-22.md (XX KB) ✅
5. 2024-02-17_北欧蜜月_实用信息.md (XX KB) ✅

✔️ 验证结果：全部文件保存完整

💡 建议按顺序阅读：总览 → 每日行程 → 实用信息
```

### 保存可能不完整
```
⚠️ 保存可能不完整！

文件已创建，但验证发现可能存在问题：
- 预期行数：~500行
- 实际行数：320行
- 缺失内容：Day 15 之后的内容

🔄 正在尝试重新保存...

[如果重试仍失败]
📋 备选方案：
1. 我将行程分成多个小文件重新保存
2. 或者您可以直接复制上面对话中的内容
```

## 注意事项

1. **写入前先确认内容完整**
   - 不要在内容还没生成完就开始保存
   - 确保行程包含所有天数

2. **大文件分段处理**
   - 超过 50KB 或 1000 行建议分段
   - 超过 15 天行程建议分文件

3. **验证是必须步骤**
   - 每次保存后都要验证
   - 验证失败要告知用户并提供解决方案

4. **保留用户对话中的内容**
   - 即使文件保存失败，对话中的内容用户仍可复制
   - 提醒用户这一点作为备选方案

